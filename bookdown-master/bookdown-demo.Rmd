--- 
title: "Mathematical Demography"
author: "Josh R. Goldstein"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
output: bookdown::gitbook
documentclass: book
bibliography: [book.bib, packages.bib, references.bib]
biblio-style: apalike
link-citations: yes
github-repo: rstudio/bookdown-demo
description: "This is a book from the Mathematical Demography lecture notes."
---
--- 
title: "Mathematical Demography"
author: "Josh R. Goldstein"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
output: bookdown::gitbook
documentclass: book
bibliography: [book.bib, packages.bib, references.bib]
biblio-style: apalike
link-citations: yes
github-repo: rstudio/bookdown-demo
description: "This is a book from the Mathematical Demography lecture notes."
---

# Introduction

Mathematical demography book

Special thank you to the Spring 2020 Mathematical Demography students for the problem set answers. 


```{r eval=FALSE, echo=FALSE}
install.packages("bookdown")
# or the development version
# devtools::install_github("rstudio/bookdown")
```

<!--chapter:end:index.Rmd-->


# Introduction to Demographic Heterogeneity {#intro}

Placeholder


## Outline
## Part I. Conceptual Introduction
### What is Demographic Heterogeneity?
#### An example
### Analogies
### What's new? 
#### A 2nd example: Exponential growth, two countries
#### More examples to work
### Application
## Part II. Formal Analysis
### Outline
### Keyfitz result
### US-Mexico Example
#### Commentary on Keyfitz result
### The Origin of Professor Wachter's Poisson-Exponential Model
#### Closed-form result
### Some commentary
## Conclusions

<!--chapter:end:01-heterogeneity.Rmd-->


# Multiplicative Fixed Frailty {#frailty}

Placeholder


## Outline
### Review of mortality mathematics
### Application: what is $\ell'(x)$?
#### Two special cases
### Extending Keyfitz to mortality
### Multiplicative Fixed frailty
## Part I. Results from Fixed Frailty
### A simulation
### Let's derive pop survival (Note: $\bar{s} = \bar{\ell}$) 
### Now population hazards (stepping stones)
### Rodriguez question
## Part II. Introduction to Gamma Frailty
### The Gamma distribution
### Gamma in R
### Population Survival of Gamma Frailty
### Interpreting Gamma-frailty survival
## Conclusions

<!--chapter:end:02-frailty.Rmd-->


# Gamma Frailty with Applications

Placeholder


## From pop survival to pop hazards
### What happens to frailty of survivors?
#### Example: Gamma-Gompertz
## Selection and observed frailty in CenSoc
### Data
### Estimation
###  Discuss our conclusions and possible future directions to follow.

<!--chapter:end:03-gamma_censoc_application.Rmd-->


# Convergence and cross-overs

Placeholder


## Outline
## What happens to mortality disparities at older ages?
### A possible null-model
### A result: \vr (5E)
### Inversion
### An example
### Application
## Student Presentation

<!--chapter:end:04-crossover.Rmd-->


# Mortality plateaus

Placeholder


## Outline
## Heterogeneity slows mortality improvement 
### An example
## Conclusions 
## Ken's class - Hazards and Plateaus
### Extremes of Longevity in Humans and Other Species 
### Gamma-Gompertz Fixed Frailty Hazards
#### How does Gamma Gompertz Make a Plateau?  
#### Troubles with Gamma Gompertz:  
#### Mathematics of Frailty as a Gamma Random Variable:    
#### @vaupel1979  
### Less Restrictive Frailty Models  
### Mutation Accumulation, Gompertz Hazards with Plateaus
#### Mutation-Selection Equilibrium
#### Deleterious Alleles with Age-Specific Effects
#### Allele Counts and Individual Hazards
#### Plateaus in Allele Counts
#### Questions for Further Study
## Key points 

<!--chapter:end:05-plateaus.Rmd-->


# Tempo

Placeholder


## Outline
## Introduction
### Fertility postponement, a very simple example
### Continuous postponement, a shiny simulation
## Period Shifts: Bongaarts and Feeney's model
### A derivation: due to Rodriguez *NOTE: not sure what the reference is here*
## An Application to the United States
### Conclusions
## Two Americas
### Mixture
### An algorithm for tempo adjustment of mixtures
## Conclusions 
### Caveats

<!--chapter:end:06-tempo.Rmd-->


# Branching Processes 

Placeholder


## Outline 
## Motivation
### Very brief history of Branching Processes 
### Applicability to the Coronavirus? Yes and no.
### Simulated examples and the questions they raise
### What is a (Bienayme)-Galton-Watson branching process?
## Simulations of parents having children
## The Probability Generating Function: Our mathematical tool
## Extinction
## Good and bad set-ups for branching process
## The distribution of offspring of all generations
## Geometric offspring distribution
### The Geometric Distribution's simple PGF
### A plot of Keyfitz's numbers for generations 1, 2, and 3. Is it exponential for $k > 0$?
## Branching Processes and Covid-19

<!--chapter:end:07-branching.Rmd-->

# Fisher-Wright

## Outline

- COVID 
- Fisher Wright vs Galton Branching Process
- FW with mutation
- Extinction
- Application: Baby Names

Additional resources:

  - Blog "Introduction to the Wright-Fisher Model" <https://stephens999.github.io/fiveMinuteStats/wright_fisher_model.html#pre-requisites>
  - @hahn2003drift:  Evolutionary anthropologists arguing that the neutral explanation of the Fisher-Wright model is consistent with the distribution of 1st names. What other quantitative or qualitative features of 1st name fashion could be used to try to reject the neutral model?
  - @felsenstein2005theoretical: Very complete "lecture notes" for graduate genetics course. Lots of good commentary, does not assume a lot of math background, but lots of content and can be diffcult to read a piece by itself. 

## Parallel


<style>
.column-left{
  float: left;
  width: 50%;
  text-align: left;
}
.column-right{
  float: right;
  width: 50%;
  text-align: left;
}
</style>


<div class="column-right">
*Fisher-Wright*

  - Children picking their parents (not "generative")
  - Total population size is constant: process goes backwards
  - Qualitatively similar to BP. Extinction and fixation.
  - Flexible: mutation, selection, even changes in pop size.
  - With apologies, biologists take FW "seriously" even if they
    don't take it "literally".
    
</div>
<div class="column-left">
  *Galton-Watson-Bienaym√® Branching Processe*
  
  - Branching process models independent parents randomly
    producing offspring. "Generative"
  - Total population size can vary, and has a random component and
    deterministic one $m$
  - Qualitative result when $m = 1$ is that there is one longest
    surviving line. This is "fixation", when one _type_ becomes
    universal.
  -
    
</div>

### Another cell phone example
As in the Branching Processes chapter, let's simulate the creation of generations using the numbers of cell-phone numbers (which are random). For this case, we need as many cell phone numbers as the generations to create, but each next cell phone number is a combination of digits from the first cell phone number. Let these ficticious cell phone numbers be: 731 660 5362 and 530 666 7723. Note how the second number does not contain any 4s, 8s or 9s.  

Generation 1 starts off with a sequence of numbers from 0 to 9. Then for generation 2, we assign each digit of the cell phone to one of cells. We repeat this for generation 3 but with the second cell phone number.   


+-----------+---------------------------------------+
| generation| allele type                           | 
|  #        |                                       |
+===========+===+===+===+===+===+===+===+===+===+===+
| 1         | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 |
+-----------+---+---+---+---+---+---+---+---+---+---+
| 2         | 7 | 3 | 1 | 6 | 6 | 0 | 5 | 3 | 6 | 2 |  
+-----------+---+---+---+---+---+---+---+---+---+---+
| 3         | 5 | 3 | 0 | 6 | 6 | 6 | 7 | 7 | 2 | 3 |
+-----------+---+---+---+---+---+---+---+---+---+---+

If we translate this graph into a tally of the alleles by generation we see that some alleles are passed/''survive'' more than others. 

+---------+-----------------------+
|allele   | Count per generation  |
| type    |   1   |   2   |   3   |
+=========+=======+=======+=======+
|    1    |   1   |   1   |   1   | 
|    2    |   1   |   1   |   1   | 
|    3    |   1   |   2   |   2   | 
|    4    |   1   |   0   |   0   | 
|    5    |   1   |   1   |   1   |
|    6    |   1   |   3   |   3   |
|    7    |   1   |   1   |   2   |
|    8    |   1   |   0   |   0   |
|    9    |   1   |   0   |   0   |
+=========+=======+=======+=======+
- Here, allele type 6 will most likely dominate. This means that everybody will likely become similar and that individual types disappear. 

**NOTE FOR JOSH**: does this explanation make sense? I had a hard time following the cell-phone number example in class so my notes are incomplete. Also, it's not so straightforward to me how the "Children are choosing their parents here". Could you explain this more?

## Mutation

Let's simulate the process from the example below. We first present some useful functions. 

```{r}
  fwm <- function(N, n_gen, mu = 0) ## mu != 4/N
  {
      ## simulate fisher-wright (with mutations)
      x <- paste(1:N) ## starting types
      A <- matrix(NA, nrow = n_gen, ncol = N)
      for (i in 1:n_gen)
      {
          A[i,] <- x
          x <- sample(x, size = N, replace = T) # Sample from previous generation and draw with replacement
          x <- mut(x, mu) 
          x
      }
      return(A) ## matrix of types, each line a generation.
  }

# Function to detect number of mutations. This occurs with probability mu. 
  mut <- function(x, mu)
  {
      ## m, the individuals that mutate
      m <- which(rbinom(length(x), size= 1, prob = mu) == 1)
      if (length(m) == 0) ## if no-one mutates
          return(x)
      ## add a suffix to their ID, so it will be unique (infinite alleles)
      suffix <- 10000*round(runif(length(m)),4)
      x[m] <- paste0(x[m], ".", suffix)
      x
  }
```

Here we try it out. Each row is a generation and each column is a type of allele. Notice that already by the third generation, there are several numbers that are not drawn anymore: 3,4,6,8,9.
```{r}
  set.seed(1)
  fwm(N = 10, n_gen = 6, mu = 0)
```   

The graph below shows a simulation of 20 generations each of size 10. The colors represent different types drawn in each generation. Let's analyze it more. 

  - By generation 5, many of the lines are flat (ocurrence = 0%) which means that they go extinct and the following generations can only select types from a reduced sample. 
  - 
- What happens at time 15?
- Why does line 5 rise and fall?
- What happens at time 2?
- What is $E(p_i(t) | p_i(t-1))$?
```{r}
  set.seed(1)
  A <- fwm(N = 10, n_gen = 20, mu = 0)
  tt <- table(A, row(A)) ## count types by row
  ptt <- prop.table(tt, 2) ## proportions
```
```{r, fig.height = 3.5, echo=FALSE, fig.cap='Generation size'}
  matplot(t(ptt), type = 'l', lty = 1, main = "Fisher-Wright simulation", xlab = "Generation #", ylab="Ocurrence (% of gen. size)"
            )
  text(x = 4, y = jitter(ptt[,4]), rownames(ptt), col = 1:6)
``` 




Bigger pop and more time
```{r, fig.height = 4}
  set.seed(1)
  A <- fwm(N = 100, n_gen = 200, mu = 0)
  tt <- table(A, row(A)) ## count types by row
  ptt <- prop.table(tt, 2) ## proportions
  matplot(t(ptt), type = 'l', lty = 1)
``` 
  
  - What does this remind you of? What will happen in long run?
  - What other questions could we ask?
  
## Fixation
Questions we can ask
  
  - What is probability that line $i$ will ``fix''? (Hint: easy)
  - What is expected time until some line fixes? (We'll demo the result)
  - How can we describe the path to fixation? (We'll derive the result)
  
  
Probability that a particular line will "fix"
```{r, fig.height = 5}
  set.seed(1)
  A <- fwm(N = 10, n_gen = 20, mu = 0)
  tt <- table(A, row(A)) ## count types by row
  ptt <- prop.table(tt, 2) ## proportions
  matplot(t(ptt), type = 'l', lty = 1, main = "FW simu")
  text(x = 4, y = jitter(ptt[,4]), rownames(ptt), col = 1:6)
``` 

Expected time until fixation?

  Answer for us is
  $$
  \bar{T}_{fixed} = 2 \cdot N
  $$
  Note: Biologists say $4 N_e$. See Wikipedia "Genetic drift"
  

Simulation of time to fixation
```{r}
  T.vec <- NULL
  all.the.same <- function(x){length(unique(x)) == 1}
  set.seed(10)
  for (i in 1:100)
  {
      A <- fwm(N = 100, n_gen = 1000,mu = 0)
      extinction_time = min(row(A)[apply(A, 1, all.the.same)])
      T.vec[i] <- extinction_time
  }
  mean(T.vec)
```

### Path to fixation: a measure of homogeneity/heterogeneity

  Chance that two randomly drawn individuals are of same type.
  $$
  G = \sum_i p_i^2
  $$

  If we have two types, $p_1 = \pi$ , $p_2 = 1-\pi$?
  What is G if $\pi = 0, .5, 1$?


Let's derive time path of G

  Let's assume just two types, $\pi(t)$

  Chance two indiv are of same type
  $$
  G_{t+1} = P(\mbox{same parent})\cdot 1 +
  P(\mbox{different parent})\cdot G_{t}
  $$

  Notation: I'm going use $K$ for pop size. Bio uses $2N$.
  $$
  G_{t+1} = {1 \over K} \cdot 1 + (1 - {1\over K}) \cdot G_{t}
  $$

  Easier to solve letting $H = 1 - G$. Some algebra gives
  $$
  H_{t+1} = H_{t} (1 - 1/K)
  $$

  Or,
  $$
  H_{t} = H_0 (1 - 1/K)^t % \rightarrow H_0 e^{-t/K}
  $$
  So, H goes to 0 exponentially, just as G goes to 1.


## Baby Names

>  "Drift as a mechanism for cultural change: an example from baby names"
by Matthew W. Hahn and R. Alexander Bentley Proc. R. Soc. Lond. B 2003 270, S120-S123

### What's the basic idea?
  
  - How is naming a baby like Fisher-Wright?
  - How is it not?
  
Applying

  - Like Fisher-Wright 
    - people choose from existing set (?)
    - names are "neutral" (?)
    - draw proportionally (?)
  - They test to see if they can reject FW
    - compare observed histograms to FW simulation
  - They include mutation to get a stationary disn
  Note: failing to reject FW doesn't mean it's correct

Their picture 

![Baby Names by Matthew W. Hahn and R. Alexander Bentley Proc. R.Soc. Lond. B 2003 270, S120-S123](/hdir/0/fmenares/Book/bookdown-master/images/hahn_pic.png)


### Fisher-Wright simulation of Baby Names (Hahn and Bentley)

Drwaing their Picture

Data prep

```{r, eval=FALSE}
download.file(url= "https://www.ssa.gov/oact/babynames/names.zip",
              "./names.zip")
unzip("names.zip", exdir = "./names")

library(data.table)

filenames <- system("ls ./names/*.txt", intern = T)
mylist <- vector("list", length(filenames))
names(mylist) <- gsub(pattern = "[^0-9]", replace = "", filenames)
for (i in 1:length(filenames))
{
    myfile <- filenames[i]
    mylist[[i]] <- fread(myfile)
}

dt <- rbindlist(mylist, idcol = "year")
names(dt) <- c("year", "name", "sex", "N")
``` 

ok, we have the data now


Plot observed frequencies
```{r, eval=FALSE}
## male 1900-1909
my.dt <- dt[sex == "M" & year %in% 1900:1909]
foo <- my.dt[, .(N = sum(N)), by = name]
foo <- foo[order(N, decreasing = T)]
bar <- foo[1:1000,] ## 1000 top names
```

now let's do a power law plot
```{r, eval=FALSE}
my.breaks <- c(0, 2^(0:11)/10000)
bar[, p := round(prop.table(N),5)]
bar[, pcat := cut(p, breaks =  my.breaks, right = F, include.lowest = T)]

out <- unclass(prop.table(table(bar$pcat)))


my.x <- my.breaks[-length(my.breaks)] + diff(my.breaks)/2
plot(my.x, out, log = "xy")
```

### Drawing their picture with simulation

FW simulation
```{r, eval=FALSE}
mut <- function(x, mu)
{
    ## m, the individuals that mutate
    m <- which(rbinom(length(x), 1, mu) == 1)
    if (length(m) == 0)
        return(x)
    suffix <- 10000*round(runif(length(m)),4)
    x[m] <- paste0(x[m], ".", suffix)
    x
}

fwm <- function(N, n_gen, mu = 0)
{
x <- paste(1:N)
A <- matrix(NA, nrow = n_gen, ncol = N)
for (i in 1:n_gen)
{
    A[i,] <- x
    x <- sample(x, size = N, replace = T)
    x <- mut(x, mu)
    x
}
return(A)
}
```

Let's look at evolution over time of G: chance that two individuals are of same type
```{r, eval=FALSE}
get.G <- function(x)
{
    tt <- table(x)
    p <- prop.table(tt)
    sum(p^2)
}
```

without mutation
```{r, eval=FALSE}
A <- fwm(1000, n_gen = 4000, mu = 0)
G.vec <- apply(A, 1, get.G)
plot(G.vec)
```

with mutation, 1 trial

```{r, eval=FALSE}
N = 1000
A <- fwm(N, n_gen = 3000, mu = 4/N)
G.vec <- apply(A, 1, get.G)
plot(G.vec)
```
average over 100 trials

```{r, eval=FALSE}
n_gen = 2000
n_trials = 100
G.mat <- matrix(NA,  n_trials, n_gen)
for (i in 1:n_trials)
    {
        N = 1000
        A <- fwm(N, n_gen, mu = 4/N)
        G.vec <- apply(A, 1, get.G)
        G.mat[i,] <- G.vec
        }
matplot(t(G.mat), type = "l")

G.bar <- apply(G.mat, 2, mean)
lines(G.bar, lwd = 4)
abline(h = 1/9, lty = 3, col = "yellow", lwd = 5)
```
cool plot, why is it about .11?
```{r, eval=FALSE}
1/(1 + 8)

```

Gillespie tells us that Gbar is supposed to be 1 / (1 + 4*Ne*mu)

How does 4*Ne*mu = 8?

Well, we have $K*mu = 4$ and since $K = 2*Ne$, $Ne = = K/2$ (maybe)

### FW babyname simulation of equilibrium frequencies 

```{r, eval=FALSE}
N = 1000 ## Not sure if this is (w)right :)
mu = 4/N ## [1] 0.004
theta = N*mu ## [1] 4 ## H&B's "best fit"
```

## Now we can simulate babyynmes
```{r, eval=FALSE}
n_gen = 1001
N = 1000
## set.seed(1)
## A <- fwm2(N, n_gen, mu = 4/N)
#A <- fwm2(N, n_gen, mu = 8/N)
###############
#What about the fwm2 function?
#######################
A <- fwm(N, n_gen, mu = 8/N)
## ok, lets do power law plot of this
x <- A[1001,]
tt <- table(x)
ptt <- prop.table(tt)
my.breaks <- c(0, 2^(0:11)/10000)
p <- ptt
## bar[, p := round(prop.table(N),5)]
##bar[, pcat := cut(p, breaks =  my.breaks, right = F, include.lowest = T)]
pcat = cut(p, breaks =  my.breaks, right = F, include.lowest = T)
out <- unclass(prop.table(table(bar$pcat)))
out.hat <- unclass(prop.table(table(pcat)))
my.x <- my.breaks[-length(my.breaks)] + diff(my.breaks)/2
plot(my.x, out, log = "xy")
lines(my.x, out.hat)
```

## Conclusions
  
  - Fisher-Wright an alternative to branching processes
  - It reverses logic of reproduction, but gives similar
    quantitative and qualitative results
  - A neutral model for other processes?
  - Starting point for coalescent

### Some potential criticism
  
  - While we can't reject that there's some parameterization of
    FW that gives us similar disn, this doesn't mean that we've
    found the right mechanism. (Just that we can't reject it).
  
  - What are some other tests of this mechanism?
  
  - Markov assumption. We could see if each frequency really
    followed random walk.
  - Perhaps we could see if variances were scaled to
    frequencies correctly.
  

<!--chapter:end:08-fw.Rmd-->


# Coalescent 

Placeholder


## Outline   
## Big picture: The Coalescent: Expectations of the Past
## Our first question: When was MRCA?
## Mutation and inference of TMRCA and $N$
## Inference of population size, simulation
## Conclusions
## An application of coalescent theory
### Coalesence when population is changing
## Inference from MRCA times: $n > 2$ comparisons and relative branch lengths
## Reconstruction Ancient European Population Sizes using Batini's sample of Mitochondrial DNA"
### Summary of Batini et al.
#### The mitochondrial DNA
### Ancient population estimates
#### Using the Coalescent to estimate changing population size
## Some exercises

<!--chapter:end:09-coalescent.Rmd-->


# Student Presentations

Placeholder


## Mortality Crossovers
### Outline
### _Mortality Crossovers: Reality or Bad Data?_ [@coale1986mortality]
#### Age heaping:
#### Takeaways
### _Methods for Evaluating the Heterogeneity of Aging Processes in Human Populations Using Vital Statistics Data: Explaining the Black/White Mortality Crossover by a Model of Mortality Selection_ [@manton1981methods]
#### Summary
#### A model of selection
#### A little bit of math
#### Parameter k
#### Takeaways
### CenSoc Mortality Crossovers
#### Can the crossover be eliminated?
#### Is death data in CenSoc file less reliable for Blacks?
#### Heaping for reported birth year
## Plateaus
## Rising Inequality
### _Trends in mortality differentials and life expectancy for male social security-covered workers, by socioeconomic status_ [@waldron2007trends]
#### Context and data
#### Methods
#### Results

<!--chapter:end:student_presentations.Rmd-->

